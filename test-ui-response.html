<!DOCTYPE html>
<html>
<head>
    <title>Test UI Response Display</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .message { margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
        .user { background-color: #f0f8ff; }
        .assistant { background-color: #f5f5f5; }
        .streaming { border-color: #007cba; }
        .error { background-color: #ffe6e6; border-color: #ff0000; }
        button { padding: 10px 20px; margin: 5px; }
        #output { white-space: pre-wrap; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Test Robo-Chat UI Response</h1>
        <button onclick="testBasicChat()">Test Basic Chat</button>
        <button onclick="testStreamingDisplay()">Test Streaming Display</button>
        <div id="messages"></div>
        <div id="output"></div>
    </div>

    <script>
        const messagesDiv = document.getElementById('messages');
        const outputDiv = document.getElementById('output');

        async function testBasicChat() {
            messagesDiv.innerHTML = '';
            outputDiv.innerHTML = 'Testing basic chat response...\n';
            
            const userMessage = { role: 'user', content: 'Hello, what is 2+2?' };
            addMessage(userMessage);
            
            try {
                const response = await fetch('http://localhost:3005/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        messages: [userMessage],
                        model: 'gpt-5-mini',
                        chatId: 'test-ui-' + Date.now(),
                        userId: 'test-user',
                        isAuthenticated: false
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                let assistantMessage = { role: 'assistant', content: '', streaming: true };
                addMessage(assistantMessage);
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || '';

                    for (const line of lines) {
                        if (line.startsWith('0:')) {
                            const textContent = line.slice(3, -1); // Remove 0:" and trailing "
                            assistantMessage.content += textContent;
                            updateMessage(assistantMessage);
                            outputDiv.innerHTML += `Received text: ${textContent}\n`;
                        }
                    }
                }
                
                assistantMessage.streaming = false;
                updateMessage(assistantMessage);
                outputDiv.innerHTML += 'Stream completed!\n';
                
            } catch (error) {
                outputDiv.innerHTML += `Error: ${error.message}\n`;
                addMessage({ role: 'error', content: error.message });
            }
        }

        async function testStreamingDisplay() {
            messagesDiv.innerHTML = '';
            outputDiv.innerHTML = 'Testing streaming display...\n';
            
            // Simulate AI SDK v5 streaming format
            const testMessage = { role: 'assistant', content: '', streaming: true };
            addMessage(testMessage);
            
            const words = 'The answer to 2+2 is 4. This is a basic arithmetic calculation.'.split(' ');
            
            for (let i = 0; i < words.length; i++) {
                testMessage.content += (i > 0 ? ' ' : '') + words[i];
                updateMessage(testMessage);
                await new Promise(resolve => setTimeout(resolve, 200));
            }
            
            testMessage.streaming = false;
            updateMessage(testMessage);
            outputDiv.innerHTML += 'Streaming simulation completed!\n';
        }

        function addMessage(message) {
            const div = document.createElement('div');
            div.className = `message ${message.role}`;
            if (message.streaming) div.classList.add('streaming');
            div.id = `msg-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`;
            div.innerHTML = `<strong>${message.role}:</strong> ${message.content}`;
            messagesDiv.appendChild(div);
            message.elementId = div.id;
        }

        function updateMessage(message) {
            if (message.elementId) {
                const element = document.getElementById(message.elementId);
                if (element) {
                    element.innerHTML = `<strong>${message.role}:</strong> ${message.content}`;
                    if (!message.streaming) {
                        element.classList.remove('streaming');
                    }
                }
            }
        }
    </script>
</body>
</html>